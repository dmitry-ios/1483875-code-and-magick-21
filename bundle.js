(()=>{"use strict";window.constants={FIRST_NAMES:["Иван","Хуан Себастьян","Мария","Кристоф","Виктор","Юлия","Люпита","Вашингтон"],LAST_NAMES:["да Марья","Верон","Мирабелла","Вальц","Онопко","Топольницкая","Нионго","Ирвинг"],COAT_COLORS:["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],EYES_COLORS:["black","red","blue","yellow","green"],FIREBALL_COLORS:["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"]},(()=>{const e=function(e){return Math.floor(Math.random()*e)};window.util={randomNumber:e,getRandomColor:function(t){return t[e(t.length)]},shuffleArray:function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),i=e[t];e[t]=e[n],e[n]=i}},createErrorMessage:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,window.scrollTo(0,0),document.body.insertAdjacentElement("afterbegin",t)}}})(),window.debounce=function(e){let t=null;return function(...n){let i=n;t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...i)}),500)}},window.mock={generateWizards:function(e){let t=[];for(let n=0;n<e;n++)t[n]={name:function(){const e=window.util.randomNumber(window.constants.FIRST_NAMES.length),t=window.util.randomNumber(window.constants.LAST_NAMES.length),n=window.util.randomNumber(2),i=window.constants.FIRST_NAMES[e],s=window.constants.LAST_NAMES[t];return n?`${s} ${i}`:`${i} ${s}`}(),coatColor:window.util.getRandomColor(window.constants.COAT_COLORS),eyesColor:window.util.getRandomColor(window.constants.EYES_COLORS)};return t}},(()=>{const e=function(e,t,n,i){const s=i?"POST":"GET",o=new XMLHttpRequest;o.responseType="json",o.timeout=5e3,o.addEventListener("load",(function(){200===o.status?t(o.response):n(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(function(){n("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.open(s,e),i?o.send(i):o.send()};window.backend={load:function(t,n){e("https://21.javascript.pages.academy/code-and-magick/data",t,n)},save:function(t,n,i){e("https://21.javascript.pages.academy/code-and-magick",n,i,t)}}})(),(()=>{const e=document.querySelector(".setup"),t=function(e,t){const n=t.cloneNode(!0);return n.querySelector(".setup-similar-label").textContent=e.name,n.querySelector(".wizard-coat").style.fill=e.colorCoat,n.querySelector(".wizard-eyes").style.fill=e.colorEyes,n};window.render={setupSimilarList:function(n){const i=function(e){const n=document.querySelector("#similar-wizard-template").content.querySelector(".setup-similar-item"),i=document.createDocumentFragment(),s=Math.min(4,e.length);for(let o=0;o<s;o++){const s=t(e[o],n);i.appendChild(s)}return i}(n),s=e.querySelector(".setup-similar-list");s.innerHTML="",s.appendChild(i),e.querySelector(".setup-similar").classList.remove("hidden")}}})(),(()=>{const e=function(){};let t={onEyesChange:e,onCoatChange:e};const n=document.querySelector(".setup"),i=n.querySelector(".setup-wizard .wizard-coat"),s=n.querySelector("input[name=coat-color]"),o=n.querySelector(".setup-wizard .wizard-eyes"),r=n.querySelector("input[name=eyes-color]"),a=n.querySelector(".setup-fireball-wrap"),d=n.querySelector("input[name=fireball-color]"),c=function(e,t,n){const i=window.util.getRandomColor(e);return t.value=i,"div"===n.tagName.toLowerCase()?n.style.backgroundColor=i:n.style.fill=i,i};i.addEventListener("click",(function(){const e=c(window.constants.COAT_COLORS,s,i);t.onCoatChange(e)})),o.addEventListener("click",(function(){const e=c(window.constants.EYES_COLORS,r,o);t.onEyesChange(e)})),a.addEventListener("click",(function(){c(window.constants.FIREBALL_COLORS,d,a)})),window.wizard={setCoatChangeHandler:function(e){t.onCoatChange=e},setEyesChangeHandler:function(e){t.onEyesChange=e}}})(),(()=>{const e=document.querySelector(".setup"),t=e.querySelector(".setup-wizard-form");let n="rgb(101, 137, 164)",i="black",s=[];const o=function(e){let t=0;return e.colorCoat===n&&(t+=2),e.colorEyes===i&&(t+=1),t},r=function(){const e=s.sort((function(e,t){let n=o(t)-o(e);return 0===n&&(n=function(e,t){return e>t?1:e<t?-1:0}(e.name,t.name)),n}));window.render.setupSimilarList(e)};window.wizard.setEyesChangeHandler(window.debounce((function(e){i=e,r()}))),window.wizard.setCoatChangeHandler(window.debounce((function(e){n=e,r()})));const a=function(){e.classList.add("hidden")},d=function(e){window.util.createErrorMessage(e)};window.backend.load((function(e){s=e,r()}),d),t.addEventListener("submit",(function(e){const n=new FormData(t);window.backend.save(n,a,d),e.preventDefault()}))})(),(()=>{const e=document.querySelector(".setup"),t=e.querySelector(".upload"),n=document.querySelector(".setup-open"),i=e.querySelector(".setup-close"),s=document.querySelector(".setup-open-icon"),o=document.querySelector(".setup-user-name"),r=function(n){n.preventDefault();let i={x:n.clientX,y:n.clientY},s=!1;const o=function(t){t.preventDefault(),s=!0;let n=i.x-t.clientX,o=i.y-t.clientY;i={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-o+"px",e.style.left=e.offsetLeft-n+"px"},r=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r),s){const e=function(n){n.preventDefault(),t.removeEventListener("click",e)};t.addEventListener("click",e)}};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)},a=function(e){"Escape"===e.key&&e.target!==o&&l()},d=function(e){"Enter"===e.key&&l()},c=function(){l()},u=function(){e.classList.remove("hidden"),i.addEventListener("click",c),i.addEventListener("keydown",d),document.addEventListener("keydown",a),t.addEventListener("mousedown",r)},l=function(){e.classList.add("hidden"),document.removeEventListener("keydown",a),i.removeEventListener("keydown",d),i.removeEventListener("click",c),t.removeEventListener("mousedown",r),e.style.top="80px",e.style.left="50%"};n.addEventListener("click",(function(){u()})),s.addEventListener("keydown",(function(e){"Enter"===e.key&&u()}))})(),(()=>{const e=document.querySelector(".setup-user-name");e.addEventListener("invalid",(function(){const t=e.validity;t.tooShort?e.setCustomValidity("Имя персонажа не может содержать менее 2 символов"):t.tooLong?e.setCustomValidity("Максимальная длина имени персонажа — 25 символов"):t.valueMissing?e.setCustomValidity("Обязательное поле"):e.setCustomValidity("")}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".upload input[type=file]"),n=document.querySelector(".setup-user-pic");t.addEventListener("change",(function(){const i=t.files[0],s=i.name.toLowerCase();if(e.some((function(e){return s.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.src=e.result})),e.readAsDataURL(i)}}))})(),(()=>{const e="#000000",t=function(e,t,n,i){e.fillStyle=i,e.fillRect(t,n,420,270)},n=function(t,n,i,s){t.fillStyle=e,t.fillText(n,i,s)},i=function(e,t,n,i,s){e.fillStyle=function(e){return"Вы"===e?"rgba(255, 0, 0, 1)":`hsl(240, ${Math.floor(100*Math.random())}%, 50%)`}(t),e.fillRect(n,i,40,s)};window.renderStatistics=function(s,o,r){t(s,110,20,"rgba(0, 0, 0, 0.7)"),t(s,100,10,"#ffffff"),function(t){t.font="16px PT Mono",t.textBaseline="hanging",t.fillStyle=e}(s),function(e,t,n,i){"Ура вы победили!\nСписок результатов:".split("\n").forEach((function(t,n){e.fillText(t,125,35+18*n)}))}(s);const a=function(e){let t=e[0];for(let n=1;n<e.length;n++)e[n]>t&&(t=e[n]);return t}(r);for(let e=0;e<o.length;e++){const t=Math.round(r[e]),d=140+90*e,c=150*r[e]/a,u=242.5-c,l=250;n(s,t,d,227.5-c),i(s,o[e],d,u,c),n(s,o[e],d,l)}}})(),window.GameConstants={Fireball:{size:window.fireballSize||24,speed:window.getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:window.wizardSpeed||2,width:window.wizardWidth||61,getHeight:window.getWizardHeight||function(e){return 1.377*e},getX:window.getWizardX||function(e){return e/3},getY:window.getWizardY||function(e){return e-100}}},window.Game=function(){var e=300,t=700,n=["Кекс","Катя","Игорь"],i={},s="-reversed";i[0]={width:61,height:84,url:"img/wizard.gif"},i[0+s]={width:61,height:84,url:"img/wizard-reversed.gif"},i[1]={width:24,height:24,url:"img/fireball.gif"};var o={0:function(n,i,s){i.keysPressed.UP&&n.y>0&&(n.direction=-9&n.direction,n.direction=4|n.direction,n.y-=n.speed*s*2),i.keysPressed.UP||n.y<e-n.height&&(n.direction=-5&n.direction,n.direction=8|n.direction,n.y+=n.speed*s/3),i.keysPressed.LEFT&&(n.direction=-3&n.direction,n.direction=1|n.direction,n.x-=n.speed*s),i.keysPressed.RIGHT&&(n.direction=-2&n.direction,n.direction=2|n.direction,n.x+=n.speed*s),n.y<0&&(n.y=0),n.y>e-n.height&&(n.y=e-n.height),n.x<0&&(n.x=0),n.x>t-n.width&&(n.x=t-n.width)},1:function(e,n,i){1&e.direction&&(e.x-=e.speed*i),2&e.direction&&(e.x+=e.speed*i),(e.x<0||e.x>t)&&(e.state=1)}},r={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},a={0:function(e){return e.garbage.filter((function(e){return 1===e.type})).filter((function(e){return e.x<10&&e.y>240}))[0]?r.WIN:r.CONTINUE}},d={0:function(n){return n.objects.push({direction:2,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:i[0],state:0,type:0,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),n}},c=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};c.prototype={level:0,setDeactivated:function(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:r.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=d[this.level](this.state)):this.state.currentStatus=r.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===r.WIN||this.state.currentStatus===r.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){var e;switch(this.state.currentStatus){case r.WIN:if(window.renderStatistics){var t=this._generateStatistics(new Date-this.state.startTime),n=this._shuffleArray(Object.keys(t));return void window.renderStatistics(this.ctx,n,n.map((function(e){return t[e]})))}e="Вы победили Газебо!\nУра!";break;case r.FAIL:e="Вы проиграли!";break;case r.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case r.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics:function(e){for(var t={Вы:e},i=0;i<n.length;i++){var s=e+(3e3*Math.random()-1500);s<1e3&&(s=1e3),t[n[i]]=s}return t},_shuffleArray:function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[n],e[n]=i}return e},_drawMessage:function(e){var t=this.ctx,n=function(e,n,i,s){t.beginPath(),t.moveTo(e,n),t.lineTo(e+10,n+s/2),t.lineTo(e,n+s),t.lineTo(e+i/2,n+s-10),t.lineTo(e+i,n+s),t.lineTo(e+i-10,n+s/2),t.lineTo(e+i,n),t.lineTo(e+i/2,n+10),t.lineTo(e,n),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",n(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",n(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach((function(e,n){t.fillText(e,200,80+20*n)}))},_preloadImagesForLevel:function(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])e();else for(var t=Object.keys(i),n=t.length,s=this,o=function(t){var i=new Image(t.width,t.height);i.onload=function(){t.image=i,0==--n&&(s._imagesArePreloaded[s.level]=!0,e())},i.src=t.url},r=0;r<t.length;r++)o(i[t[r]])},updateObjects:function(e){var t=this.state.objects.filter((function(e){return 0===e.type}))[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(1&t.direction)),sprite:i[1],type:1,width:window.GameConstants.Fireball.size,x:2&t.direction?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var n=this.state.objects.filter((function(t){return o[t.type](t,this.state,e),1!==t.state||(this.state.garbage.push(t),!1)}),this);this.state.objects=n},checkStatus:function(){if(this.state.currentStatus===r.CONTINUE){this.commonRules||(this.commonRules=[function(e){return 1===e.objects.filter((function(e){return 0===e.type}))[0].state?r.FAIL:r.CONTINUE},function(e){return e.keysPressed.ESC?r.PAUSE:r.CONTINUE},function(e){return Date.now()-e.startTime>18e4?r.FAIL:r.CONTINUE}]);for(var e=this.commonRules.concat(a[this.level]),t=r.CONTINUE;t===r.CONTINUE&&e.length;)t=e.shift()(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach((function(e){if(e.sprite){var t=1&e.direction,n=i[e.type+(t?s:"")]||i[e.type];this.ctx.drawImage(n.image,e.x,e.y,e.width,e.height)}}),this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case r.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case r.WIN:case r.FAIL:case r.PAUSE:case r.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},c.Verdict=r;var u=new c(document.querySelector(".demo"));return window.restartGame=function(e,t){i[0].url=e,i[0+s].url=t,u.initializeLevelAndStart(),u.setGameStatus(r.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),u}()})();